// Configuration GitHub
const GITHUB_CONFIG = {
    token: '', // √Ä configurer par l'utilisateur
    owner: 'theojacoby',
    repo: 'ttstpierre2',
    filePath: 'data.json'
};

// Variables globales
let selectedTeam = null;
let currentMatchData = null;
let allMatchesData = null;

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

async function initializeApp() {
    try {
        console.log('üöÄ Initialisation du dashboard...');
        
        // Configurer les √©v√©nements d'abord (pour que les boutons soient cliquables)
        setupEventListeners();
        
        // Demander le token GitHub si pas configur√©
        if (!GITHUB_CONFIG.token) {
            requestGitHubToken();
            return;
        }
        
        // Charger les donn√©es depuis GitHub
        await loadMatchData();
        
        console.log('‚úÖ Dashboard capitaines initialis√©');
    } catch (error) {
        console.error('‚ùå Erreur lors de l\'initialisation:', error);
        showStatus('Erreur lors du chargement des donn√©es. Les boutons d\'√©quipe devraient quand m√™me fonctionner.', 'error');
        
        // M√™me en cas d'erreur, permettre la s√©lection d'√©quipe
        setupEventListeners();
    }
}

function requestGitHubToken() {
    const token = prompt('üîë Entrez votre token GitHub pour permettre la mise √† jour automatique des donn√©es :\n\n(Optionnel - vous pouvez laisser vide pour tester l\'interface)');
    
    if (token && token.trim()) {
        GITHUB_CONFIG.token = token.trim();
        console.log('‚úÖ Token GitHub configur√©');
        
        // Recharger les donn√©es avec le token
        loadMatchData().then(() => {
            showStatus('‚úÖ Token configur√© et donn√©es charg√©es !', 'success');
        }).catch(error => {
            console.error('‚ùå Erreur avec le token:', error);
            showStatus('‚ùå Token invalide ou erreur de connexion', 'error');
        });
    } else {
        console.log('‚ÑπÔ∏è Pas de token configur√© - mode test uniquement');
        showStatus('‚ÑπÔ∏è Mode test - Configurez un token GitHub pour la mise √† jour automatique', 'info');
    }
}

function setupEventListeners() {
    console.log('üîß Configuration des √©v√©nements...');
    
    // Boutons d'√©quipe
    const teamButtons = document.querySelectorAll('.team-btn');
    console.log(`üìã ${teamButtons.length} boutons d'√©quipe trouv√©s`);
    
    teamButtons.forEach((btn, index) => {
        console.log(`Bouton ${index + 1}: ${btn.dataset.team}`);
        btn.addEventListener('click', function() {
            console.log(`üñ±Ô∏è Clic sur l'√©quipe: ${this.dataset.team}`);
            selectTeam(this.dataset.team);
        });
    });
    
    // Bouton d'envoi
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        submitBtn.addEventListener('click', submitResults);
        console.log('‚úÖ Bouton d\'envoi configur√©');
    } else {
        console.log('‚ùå Bouton d\'envoi non trouv√©');
    }
    
    // Validation en temps r√©el
    const inputs = document.querySelectorAll('input');
    inputs.forEach(input => {
        input.addEventListener('input', validateForm);
    });
    
    console.log('‚úÖ √âv√©nements configur√©s');
}

async function loadMatchData() {
    try {
        const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.filePath}`, {
            headers: {
                'Authorization': `token ${GITHUB_CONFIG.token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const fileData = await response.json();
        const content = atob(fileData.content);
        allMatchesData = JSON.parse(content);
        
        console.log('‚úÖ Donn√©es charg√©es depuis GitHub');
    } catch (error) {
        console.error('‚ùå Erreur lors du chargement:', error);
        throw error;
    }
}

function selectTeam(teamName) {
    console.log(`üéØ S√©lection de l'√©quipe: ${teamName}`);
    
    // D√©s√©lectionner tous les boutons
    document.querySelectorAll('.team-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    // S√©lectionner le bouton cliqu√©
    event.target.classList.add('selected');
    
    selectedTeam = teamName;
    
    // Trouver le match de cette √©quipe
    const match = findTeamMatch(teamName);
    if (match) {
        console.log('‚úÖ Match trouv√©:', match);
        currentMatchData = match;
        showMatchForm(match);
    } else {
        console.log('‚ùå Aucun match trouv√© pour', teamName);
        showStatus(`Aucun match trouv√© pour ${teamName}. V√©rifiez que les donn√©es sont charg√©es.`, 'error');
        
        // Afficher quand m√™me un formulaire de test
        showTestForm(teamName);
    }
}

function findTeamMatch(teamName) {
    if (!allMatchesData || !allMatchesData.matchs_du_jour) {
        return null;
    }
    
    return allMatchesData.matchs_du_jour.find(match => 
        match.home === teamName || match.away === teamName
    );
}

function showMatchForm(match) {
    const matchForm = document.getElementById('matchForm');
    const matchTitle = document.getElementById('matchTitle');
    
    // Afficher le formulaire
    matchForm.style.display = 'block';
    
    // Mettre √† jour le titre
    matchTitle.textContent = `Match : ${match.home} vs ${match.away}`;
    
    // G√©n√©rer les joueurs
    generatePlayersForm(match);
    
    // R√©initialiser les scores
    document.getElementById('ourScore').value = match.score1 || 0;
    document.getElementById('opponentScore').value = match.score2 || 0;
    
    // Valider le formulaire
    validateForm();
}

function showTestForm(teamName) {
    const matchForm = document.getElementById('matchForm');
    const matchTitle = document.getElementById('matchTitle');
    
    // Afficher le formulaire
    matchForm.style.display = 'block';
    
    // Mettre √† jour le titre avec un message de test
    matchTitle.textContent = `Test - ${teamName} (donn√©es non charg√©es)`;
    
    // G√©n√©rer un formulaire de test avec des joueurs fictifs
    const testMatch = {
        home: teamName,
        away: "Adversaire",
        joueurs: [
            { nom: "Joueur 1" },
            { nom: "Joueur 2" },
            { nom: "Joueur 3" },
            { nom: "Joueur 4" }
        ]
    };
    
    generatePlayersForm(testMatch);
    
    // R√©initialiser les scores
    document.getElementById('ourScore').value = 0;
    document.getElementById('opponentScore').value = 0;
    
    // Valider le formulaire
    validateForm();
}

function generatePlayersForm(match) {
    const playersGrid = document.getElementById('playersGrid');
    playersGrid.innerHTML = '';
    
    const players = match.joueurs || [];
    
    players.forEach((player, index) => {
        const playerCard = document.createElement('div');
        playerCard.className = 'player-card';
        playerCard.innerHTML = `
            <h4>${player.nom}</h4>
            <label>Victoires :</label>
            <input type="number" 
                   id="player-${index}" 
                   min="0" 
                   max="4" 
                   value="${player.victoires || 0}"
                   placeholder="0">
        `;
        playersGrid.appendChild(playerCard);
    });
    
    // Ajouter les √©v√©nements de validation
    const playerInputs = playersGrid.querySelectorAll('input');
    playerInputs.forEach(input => {
        input.addEventListener('input', validateForm);
    });
}

function validateForm() {
    const ourScore = parseInt(document.getElementById('ourScore').value) || 0;
    const opponentScore = parseInt(document.getElementById('opponentScore').value) || 0;
    
    // V√©rifier que les scores sont valides
    const scoresValid = ourScore >= 0 && opponentScore >= 0 && (ourScore + opponentScore) <= 32;
    
    // V√©rifier que la somme des victoires des joueurs correspond au score
    const playerInputs = document.querySelectorAll('#playersGrid input');
    let totalVictories = 0;
    
    playerInputs.forEach(input => {
        totalVictories += parseInt(input.value) || 0;
    });
    
    const victoriesValid = totalVictories === ourScore;
    
    // Activer/d√©sactiver le bouton
    const submitBtn = document.getElementById('submitBtn');
    const isValid = scoresValid && victoriesValid && selectedTeam;
    
    submitBtn.disabled = !isValid;
    
    // Afficher les messages d'erreur
    if (ourScore > 0 || opponentScore > 0) {
        if (!scoresValid) {
            showStatus('Les scores doivent √™tre valides (max 16 chacun)', 'error');
        } else if (!victoriesValid) {
            showStatus(`La somme des victoires (${totalVictories}) doit correspondre au score de votre √©quipe (${ourScore})`, 'error');
        } else {
            showStatus('Formulaire valide', 'success');
        }
    }
}

async function submitResults() {
    const submitBtn = document.getElementById('submitBtn');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');
    
    // Afficher l'√©tat de chargement
    submitBtn.classList.add('loading');
    submitBtn.disabled = true;
    
    try {
        // Collecter les donn√©es du formulaire
        const formData = collectFormData();
        
        // Mettre √† jour les donn√©es
        updateMatchData(formData);
        
        // Envoyer vers GitHub
        await sendToGitHub();
        
        showStatus('‚úÖ R√©sultats envoy√©s avec succ√®s !', 'success');
        
        // R√©initialiser le formulaire apr√®s 3 secondes
        setTimeout(() => {
            resetForm();
        }, 3000);
        
    } catch (error) {
        console.error('‚ùå Erreur lors de l\'envoi:', error);
        showStatus(`‚ùå Erreur lors de l'envoi: ${error.message}`, 'error');
    } finally {
        // Masquer l'√©tat de chargement
        submitBtn.classList.remove('loading');
        submitBtn.disabled = false;
    }
}

function collectFormData() {
    const ourScore = parseInt(document.getElementById('ourScore').value);
    const opponentScore = parseInt(document.getElementById('opponentScore').value);
    
    const players = [];
    const playerInputs = document.querySelectorAll('#playersGrid input');
    
    playerInputs.forEach((input, index) => {
        const playerName = currentMatchData.joueurs[index].nom;
        players.push({
            nom: playerName,
            victoires: parseInt(input.value) || 0
        });
    });
    
    return {
        ourScore,
        opponentScore,
        players
    };
}

function updateMatchData(formData) {
    // Trouver l'index du match dans les donn√©es
    const matchIndex = allMatchesData.matchs_du_jour.findIndex(match => 
        match.home === selectedTeam || match.away === selectedTeam
    );
    
    if (matchIndex !== -1) {
        // Mettre √† jour les scores
        allMatchesData.matchs_du_jour[matchIndex].score1 = formData.ourScore;
        allMatchesData.matchs_du_jour[matchIndex].score2 = formData.opponentScore;
        
        // Mettre √† jour les joueurs
        allMatchesData.matchs_du_jour[matchIndex].joueurs = formData.players;
        
        console.log('‚úÖ Donn√©es mises √† jour localement');
    }
}

async function sendToGitHub() {
    try {
        // R√©cup√©rer le SHA du fichier existant
        const getResponse = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.filePath}`, {
            headers: {
                'Authorization': `token ${GITHUB_CONFIG.token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });
        
        if (!getResponse.ok) {
            throw new Error(`Erreur lors de la r√©cup√©ration du fichier: ${getResponse.status}`);
        }
        
        const fileData = await getResponse.json();
        const sha = fileData.sha;
        
        // Pr√©parer le contenu
        const content = JSON.stringify(allMatchesData, null, 2);
        const encodedContent = btoa(unescape(encodeURIComponent(content)));
        
        // Envoyer la mise √† jour
        const updateResponse = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.filePath}`, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${GITHUB_CONFIG.token}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: `Update match results - ${selectedTeam} vs ${currentMatchData.home === selectedTeam ? currentMatchData.away : currentMatchData.home}`,
                content: encodedContent,
                sha: sha
            })
        });
        
        if (!updateResponse.ok) {
            const errorData = await updateResponse.json();
            throw new Error(`Erreur GitHub: ${errorData.message || updateResponse.statusText}`);
        }
        
        console.log('‚úÖ Donn√©es envoy√©es vers GitHub avec succ√®s');
        
    } catch (error) {
        console.error('‚ùå Erreur lors de l\'envoi vers GitHub:', error);
        throw error;
    }
}

function showStatus(message, type) {
    const statusMessage = document.getElementById('statusMessage');
    statusMessage.textContent = message;
    statusMessage.className = `status-message ${type}`;
    
    // Masquer le message apr√®s 5 secondes
    setTimeout(() => {
        statusMessage.textContent = '';
        statusMessage.className = 'status-message';
    }, 5000);
}

function resetForm() {
    // R√©initialiser la s√©lection d'√©quipe
    document.querySelectorAll('.team-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    // Masquer le formulaire
    document.getElementById('matchForm').style.display = 'none';
    
    // R√©initialiser les variables
    selectedTeam = null;
    currentMatchData = null;
    
    // Masquer le message de statut
    showStatus('', '');
}
